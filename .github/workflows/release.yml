name: ðŸš€ Release

permissions:
  contents: write

on:
  release:
    types: [published]

jobs:
  build:
    name: ðŸ“¦ Build
    uses: ./.github/workflows/_build.yml
    with:
      use-exact-version: true

  publish:
    name: ðŸ“¤ Publish to PyPI
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: Download distributions
      uses: actions/download-artifact@v4
      with:
        name: ${{ needs.build.outputs.artifact-name }}
        path: dist

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true
        cache-dependency-path: pyproject.toml

    - name: Publish to PyPI
      env:
        # you can keep using the same secrets, just wired into uvâ€™s env vars
        UV_PUBLISH_USERNAME: ${{ secrets.PYPI_USERNAME }}
        UV_PUBLISH_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
      run: |
        uv publish dist/*

    - name: Upload Release Assets
      if: success()
      run: |
        gh release upload "${{ github.event.release.tag_name }}" dist/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-docs:
    name: ðŸ“– Deploy Versioned Docs
    needs: publish
    uses: ./.github/workflows/_docs.yml
    with:
      deploy: true
      version: ${{ github.event.release.tag_name }}
      alias: latest
      set-default: true
