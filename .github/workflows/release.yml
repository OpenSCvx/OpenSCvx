name: ðŸš€ Release

permissions:
  contents: write

on:
  release:
    types: [published]

jobs:
  build:
    name: ðŸ“¦ Build
    uses: ./.github/workflows/_build.yml
    with:
      use-exact-version: true

  publish:
    name: ðŸ“¤ Publish to PyPI
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: Download distributions
      uses: actions/download-artifact@v4
      with:
        name: ${{ needs.build.outputs.artifact-name }}
        path: dist

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true

    - name: Install twine
      run: uv pip install --system twine

    - name: Publish to PyPI
      env:
        TWINE_USERNAME: ${{ secrets.PYPI_USERNAME }}
        TWINE_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
      run: |
        twine upload \
          --non-interactive \
          --verbose \
          --skip-existing \
          dist/*

    - name: Upload Release Assets
      if: success()
      run: |
        gh release upload "${{ github.event.release.tag_name }}" dist/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-docs:
    name: ðŸ“– Deploy Documentation
    runs-on: ubuntu-latest
    needs: publish
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git Credentials
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com

      - uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install documentation tools
        run: |
          uv pip install --system mkdocs-material mkdocstrings-python mike
          uv pip install --system mkdocs-gen-files mkdocs-literate-nav mkdocs-section-index
          sudo apt-get update && sudo apt-get install -y pngquant

      - name: Install package
        run: uv pip install --system -e .

      - name: Deploy versioned documentation
        run: |
          git fetch origin gh-pages --depth=1 || true
          VERSION="${{ github.event.release.tag_name }}"
          mike deploy --push --update-aliases "${VERSION}" latest
          mike set-default --push latest
