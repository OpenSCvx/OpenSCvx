name: ðŸŒ™ Nightly

permissions:
  contents: read  # Default - least privilege

on:
  push:
    branches:
      - main
  # schedule:
  #   - cron: '0 0 * * *'   # daily at midnight UTC

concurrency:
  group: nightly
  cancel-in-progress: true

jobs:
  build:
    name: ðŸ“¦ Build
    uses: ./.github/workflows/_build.yml
    with:
      use-exact-version: false

  docs:
    name: ðŸ“– Deploy Nightly Docs
    permissions:
      contents: write  # Needs write for pushing to gh-pages
    uses: ./.github/workflows/_docs.yml
    with:
      deploy: true
      version: nightly

  publish:
    name: ðŸ“¤ Publish to TestPyPI
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: Download distributions
      uses: actions/download-artifact@v4
      with:
        name: ${{ needs.build.outputs.artifact-name }}
        path: dist

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true

    - name: Install twine
      run: uv pip install --system twine

    - name: Publish to TestPyPI
      env:
        TWINE_USERNAME: ${{ secrets.TEST_PYPI_USERNAME }}
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_PASSWORD }}
      run: |
        twine upload \
          --repository testpypi \
          --non-interactive \
          --verbose \
          --skip-existing \
          dist/*
