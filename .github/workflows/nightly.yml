name: ðŸŒ™ Nightly

permissions:
  contents: read  # Default - least privilege

on:
  push:
    branches:
      - main
  # schedule:
  #   - cron: '0 0 * * *'   # daily at midnight UTC

concurrency:
  group: nightly
  cancel-in-progress: true

jobs:
  build:
    name: ðŸ“¦ Build
    uses: ./.github/workflows/_build.yml
    with:
      use-exact-version: false

  docs:
    name: ðŸ“– Deploy Nightly Docs
    needs: build  # Wait for build to succeed, but don't depend on publish
    permissions:
      contents: write  # Needs write for pushing to gh-pages
    uses: ./.github/workflows/_docs.yml
    with:
      deploy: true
      version: nightly

  publish:
    name: ðŸ“¤ Publish to TestPyPI
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: Download distributions
      uses: actions/download-artifact@v4
      with:
        name: ${{ needs.build.outputs.artifact-name }}
        path: dist

    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        enable-cache: true

    - name: Publish to TestPyPI
      env:
        # reuse your existing secrets, just mapped to uv's env vars
        UV_PUBLISH_USERNAME: ${{ secrets.TEST_PYPI_USERNAME }}
        UV_PUBLISH_PASSWORD: ${{ secrets.TEST_PYPI_PASSWORD }}
        UV_PUBLISH_URL: https://test.pypi.org/legacy/
      run: |
        uv publish --skip-existing dist/*
